---
title: "25 faces"
author: "Rama"
date: "2022-07-21"
output: html_document
---
#This is the analysis for the NW-W condition (1st pilot version).
#Install necessary packages:
```{r setup, include=FALSE}
install.packages("tidyverse")
library(tidyverse)
library(jsonlite)
```

```{r data_loading}
library(jsonlite)
library(dplyr)
library(tidyverse)
library(ggplot2)  
library(ggforce)
library(sjPlot)
library(lme4)
library(lmerTest)
library(interactions)
library(ggpubr)
library(texreg)
library(reghelper)
```
#getting all data names:
```{r loading_data} 
setwd("pilot1")
##### uploading every json file and creating one big file #####

#read all the files with jason ending
filenames <- list.files(pattern="*.json", recursive = T)

files <- lapply (filenames, fromJSON)
isCompleted <- lapply(files, nrow)
# we have 12 trials in total
completedData <- files[isCompleted == 12 ]
# every trial is in all_data combined
all_data <- do.call("bind_rows", completedData)
raw_data <- all_data
unique(raw_data$trial_type)

#data trandformation as the data from different variables loook different - goal: to combine them in the end

# trial index 0 = attention check
atten_trial <- 0
atten_data <- raw_data[raw_data$trial_index == atten_trial, ]
atten_data <- atten_data %>% unnest(response)
names(atten_data)[names(atten_data) == "response"] <- "attention_check"

# trial index 1 = prolific id 
prolific_trial <- 1
prolific_data <- raw_data[raw_data$trial_index == prolific_trial, ]
prolific_data <- prolific_data %>% unnest(response)
names(prolific_data)[names(prolific_data) == "response"] <- "prolific_id"

# trial index 2 = response to start the questionnaire
start_response_trial <- 2
start_response_data <- raw_data[raw_data$trial_index == start_response_trial, ]
start_response_data <- start_response_data %>% unnest(response)
names(start_response_data)[names(start_response_data) == "response"] <- "start_response"

#trial index 3,4,5,6,7 for the organizations 1-5
org_trials <- c(3,4,5, 6, 7)
org_data <- raw_data[raw_data$trial_index %in% org_trials, ]
org_data <- org_data %>% unnest(response)  
org_data <- org_data %>% pivot_wider(names_from = name, values_from = value)

#trial index 6 for the moderator SDO 
moderator_trials <- c(8)
mod_data <- raw_data[raw_data$trial_index %in% moderator_trials, ]
mod_data <- mod_data %>% unnest(response) 
mod_data <- mod_data %>% pivot_wider(names_from = name, values_from = value)

#trial index 9 for the demographics
demographics_trials <- c(9)
demo_data <- raw_data[raw_data$trial_index %in% demographics_trials, ]
demo_data <- demo_data %>% unnest(response)
demo_data_wo_ethnic <- demo_data[demo_data$name != "ethnic[]", ]  %>% pivot_wider(names_from = name, values_from = value)
demo_data_ethnic <- demo_data[demo_data$name == "ethnic[]", ]
demo_data_ethnic <- demo_data_ethnic %>% nest(ethnic = c( value))
demo_data <- inner_join(demo_data_ethnic[, c("rt", "subject", "ethnic")], demo_data_wo_ethnic, by="subject")
  
# trial index 10 for feedback 
followup_trials <- c(10)
followup_data <- raw_data[raw_data$trial_index %in% followup_trials, ]
followup_data <- followup_data %>% unnest(response)
names(followup_data)[names(followup_data) == "response"] <- "followup_response"

```
```{r join_individual_data}
demo_cols <- c("ethnic", "age", "children", "economic", "edu", "employment", "gender", "gender_description", "income", "ladder", "marital", "social")
df <- inner_join(org_data, mod_data[, c("rt", "subject", "A1", "A2", "A3", "A4", "A5", "A6", "A7", "A8", "B1", "B2", "B3", "B4", "B5", "B6")], by = "subject") 
df <- inner_join(df, demo_data[, c("subject", demo_cols)], by = "subject") 
df <- inner_join(df, followup_data[, c("subject", "followup_response")], by = "subject") 
df <- inner_join(df, atten_data[, c("subject", "attention_check")], by = "subject") 

```
```{r}

#finding out lists in df 
sapply(df,class)

#unlist df to work with it
preprocessed_data <- apply(df,2,as.character)

#create excel document form json
x = write.csv(preprocessed_data, "/Users/ramat/Desktop/preprocessed_data_1.csv")

```
